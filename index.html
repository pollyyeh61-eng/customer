import 'package:flutter/material.dart';
import 'package:firebase_core/firebase_core.dart';
import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:intl/intl.dart';
import 'package:url_launcher/url_launcher.dart';
import 'dart:convert';
import 'package:web/web.dart' as web;
import 'dart:js_interop';

void main() async {
  WidgetsFlutterBinding.ensureInitialized();
  await Firebase.initializeApp(
    options: const FirebaseOptions(
      apiKey: "AIzaSyCOhBN9TH3UJSOSx5XVyQ08f_2RUckvXYU",
      appId: "1:960169055224:web:96d6d47280c5d543bf3c0d",
      messagingSenderId: "960169055224",
      projectId: "holyhairsalon-f73bf",
      authDomain: "holyhairsalon-f73bf.firebaseapp.com",
      storageBucket: "holyhairsalon-f73bf.firebasestorage.app",
    ),
  );
  runApp(const LuxuryCustomerApp());
}

class LuxuryColor {
  static const Color gold = Color(0xFFD4AF37);
  static const Color darkGold = Color(0xFF8E6D2F);
  static const Color bg = Color(0xFF050505);
  static const Color card = Color(0xFF121212);
}

class LuxuryCustomerApp extends StatelessWidget {
  const LuxuryCustomerApp({super.key});
  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      debugShowCheckedModeBanner: false,
      theme: ThemeData(
        brightness: Brightness.dark,
        scaffoldBackgroundColor: LuxuryColor.bg,
        primaryColor: LuxuryColor.gold,
      ),
      home: const MainTabScreen(),
    );
  }
}

class MainTabScreen extends StatefulWidget {
  const MainTabScreen({super.key});
  @override
  State<MainTabScreen> createState() => _MainTabScreenState();
}

class _MainTabScreenState extends State<MainTabScreen> {
  int _currentIndex = 0;
  final List<Widget> _pages = [const CustomerFormPage(), const CustomerListPage()];

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      body: _pages[_currentIndex],
      bottomNavigationBar: BottomNavigationBar(
        backgroundColor: LuxuryColor.bg,
        selectedItemColor: LuxuryColor.gold,
        unselectedItemColor: Colors.grey,
        currentIndex: _currentIndex,
        onTap: (index) => setState(() => _currentIndex = index),
        items: const [
          BottomNavigationBarItem(icon: Icon(Icons.person_add), label: 'Êñ∞Â¢ûÊ™îÊ°à'),
          BottomNavigationBarItem(icon: Icon(Icons.badge), label: 'ÂêçÂñÆÁ∏ΩË¶Ω'),
        ],
      ),
    );
  }
}

// --- ÂÆ¢Êà∂Êñ∞Â¢ûÈ†ÅÈù¢ (‰øùÁïô Google Êó•ÊõÜÂêåÊ≠•) ---
class CustomerFormPage extends StatefulWidget {
  const CustomerFormPage({super.key});
  @override
  State<CustomerFormPage> createState() => _CustomerFormPageState();
}

class _CustomerFormPageState extends State<CustomerFormPage> with SingleTickerProviderStateMixin {
  late AnimationController _glowController;
  final _nameController = TextEditingController();
  final _phoneController = TextEditingController();
  final _noteController = TextEditingController();
  final _serviceController = TextEditingController();
  final _nextDateController = TextEditingController();
  final _nextItemController = TextEditingController();

  String? _selectedBlood;
  String? _selectedZodiac;
  final List<String> _bloodTypes = ['A', 'B', 'O', 'AB'];
  final List<String> _zodiacs = ['Áâ°ÁæäÂ∫ß', 'ÈáëÁâõÂ∫ß', 'ÈõôÂ≠êÂ∫ß', 'Â∑®ËüπÂ∫ß', 'ÁçÖÂ≠êÂ∫ß', 'ËôïÂ•≥Â∫ß', 'Â§©Áß§Â∫ß', 'Â§©Ë†çÂ∫ß', 'Â∞ÑÊâãÂ∫ß', 'Êë©ÁæØÂ∫ß', 'Ê∞¥Áì∂Â∫ß', 'ÈõôÈ≠öÂ∫ß'];

  @override
  void initState() {
    super.initState();
    _glowController = AnimationController(vsync: this, duration: const Duration(seconds: 4))..repeat(reverse: true);
  }

  void _openGoogleCalendar() async {
    if (_nextDateController.text.isEmpty) return;
    final String title = Uri.encodeComponent('HolyHair È†êÁ¥ÑÔºö${_nameController.text}');
    final String desc = Uri.encodeComponent('È†ÖÁõÆÔºö${_nextItemController.text}\nÂÇôË®ªÔºö${_noteController.text}');
    final String dateFormatted = _nextDateController.text.replaceAll(RegExp(r'[- : ]'), '');
    final String url = "https://www.google.com/calendar/render?action=TEMPLATE&text=$title&details=$desc&dates=${dateFormatted}00/${dateFormatted}00";
    final uri = Uri.parse(url);
    if (await canLaunchUrl(uri)) await launchUrl(uri);
  }

  Future<void> _saveData() async {
    if (_nameController.text.isEmpty) return;
    String log = "${DateFormat('yyyy-MM-dd HH:mm').format(DateTime.now())}: ${_serviceController.text}";
    
    await FirebaseFirestore.instance.collection('customers').doc(_nameController.text).set({
      'name': _nameController.text,
      'phone': _phoneController.text,
      'bloodType': _selectedBlood ?? '',
      'constellation': _selectedZodiac ?? '',
      'note': _noteController.text,
      'nextDate': _nextDateController.text,
      'nextItem': _nextItemController.text,
      'historyLogs': FieldValue.arrayUnion([log]),
      'lastUpdated': FieldValue.serverTimestamp(),
    }, SetOptions(merge: true));

    if (_nextDateController.text.isNotEmpty) _openGoogleCalendar();

    ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text("Â∞äÊ¶ÆË≥áÊñôÂ∑≤ÂêåÊ≠•"), backgroundColor: LuxuryColor.darkGold));
    _clear();
  }

  void _clear() {
    _nameController.clear(); _phoneController.clear(); _noteController.clear();
    _serviceController.clear(); _nextDateController.clear(); _nextItemController.clear();
    setState(() { _selectedBlood = null; _selectedZodiac = null; });
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: const Text('HolyHair Êñ∞Â¢ûË≤¥Ë≥ì', style: TextStyle(color: LuxuryColor.gold, letterSpacing: 2)), backgroundColor: Colors.transparent),
      body: SingleChildScrollView(
        padding: const EdgeInsets.all(25),
        child: Column(
          children: [
            _buildField(_nameController, "Ë≤¥Ë≥ìÂ∞äÂßìÂ§ßÂêç", Icons.person_outline),
            _buildField(_phoneController, "ËÅØÁπ´ÈõªË©±", Icons.phone_iphone),
            Row(children: [
              Expanded(child: _buildDropdown('Ë°ÄÂûã', _bloodTypes, _selectedBlood, (v) => setState(() => _selectedBlood = v))),
              const SizedBox(width: 15),
              Expanded(child: _buildDropdown('ÊòüÂ∫ß', _zodiacs, _selectedZodiac, (v) => setState(() => _selectedZodiac = v))),
            ]),
            const SizedBox(height: 20),
            _buildField(_noteController, "Â∞àÂ±¨ÂÇôË®ª (ËÜöË≥™ÂñúÂ•Ω)", Icons.auto_awesome, maxLines: 2),
            _buildField(_serviceController, "Êú¨Ê¨°ÊúçÂãôÁ¥ÄÂØ¶", Icons.history_edu, maxLines: 2),
            _buildAppointmentSection(),
            const SizedBox(height: 30),
            _buildLuxuryButton(),
          ],
        ),
      ),
    );
  }

  Widget _buildAppointmentSection() {
    return Container(
      padding: const EdgeInsets.all(15),
      decoration: BoxDecoration(color: LuxuryColor.card, borderRadius: BorderRadius.circular(12), border: Border.all(color: Colors.white10)),
      child: Column(children: [
        _buildField(_nextItemController, "‰∏ãÊ¨°È†êÁ¥ÑÈ†ÖÁõÆ", Icons.calendar_today),
        TextField(
          controller: _nextDateController, readOnly: true,
          decoration: const InputDecoration(labelText: '‰∏ãÊ¨°È†êÁ¥ÑÊôÇÈñì', prefixIcon: Icon(Icons.event, color: LuxuryColor.darkGold)),
          onTap: () async {
            DateTime? d = await showDatePicker(context: context, initialDate: DateTime.now(), firstDate: DateTime.now(), lastDate: DateTime(2100));
            if (d != null) {
              TimeOfDay? t = await showTimePicker(context: context, initialTime: TimeOfDay.now());
              if (t != null) setState(() => _nextDateController.text = DateFormat('yyyy-MM-dd HH:mm').format(DateTime(d.year, d.month, d.day, t.hour, t.minute)));
            }
          },
        ),
      ]),
    );
  }

  Widget _buildField(TextEditingController ctrl, String label, IconData icon, {int maxLines = 1}) {
    return Padding(
      padding: const EdgeInsets.only(bottom: 15),
      child: TextField(
        controller: ctrl, maxLines: maxLines,
        decoration: InputDecoration(
          prefixIcon: Icon(icon, color: LuxuryColor.darkGold), labelText: label,
          filled: true, fillColor: LuxuryColor.card,
          enabledBorder: OutlineInputBorder(borderRadius: BorderRadius.circular(10), borderSide: const BorderSide(color: Colors.white10)),
        ),
      ),
    );
  }

  Widget _buildDropdown(String label, List<String> items, String? current, ValueChanged<String?> onChanged) {
    return DropdownButtonFormField<String>(
      decoration: InputDecoration(labelText: label, filled: true, fillColor: LuxuryColor.card),
      value: current, items: items.map((s) => DropdownMenuItem(value: s, child: Text(s))).toList(), onChanged: onChanged,
    );
  }

  Widget _buildLuxuryButton() {
    return AnimatedBuilder(
      animation: _glowController,
      builder: (context, child) {
        final color = Color.lerp(LuxuryColor.darkGold, LuxuryColor.gold, _glowController.value)!;
        return GestureDetector(
          onTap: _saveData,
          child: Container(
            height: 60, width: double.infinity,
            decoration: BoxDecoration(
              borderRadius: BorderRadius.circular(30), border: Border.all(color: color, width: 2),
              boxShadow: [BoxShadow(color: color.withOpacity(0.4), blurRadius: 15 * _glowController.value)],
              gradient: LinearGradient(colors: [LuxuryColor.card, color.withOpacity(0.15)]),
            ),
            child: const Center(child: Text("ÂÑ≤Â≠ò‰∏¶ÂêåÊ≠•Êó•ÊõÜ", style: TextStyle(color: Colors.white, fontWeight: FontWeight.bold, letterSpacing: 2))),
          ),
        );
      },
    );
  }
}

// --- ÂÆ¢Êà∂ÂàóË°®È†ÅÈù¢ (ÂåÖÂê´ÂÇô‰ªΩ‰∏ãËºâ) ---
class CustomerListPage extends StatelessWidget {
  const CustomerListPage({super.key});

  void _downloadBackup(List<Map<String, dynamic>> list) {
    String content = "HolyHair ÂÇô‰ªΩ\n" + "="*20 + "\n";
    for (var c in list) {
      content += "„Äê${c['name']}„ÄëÈõªË©±: ${c['phone']}\nÊúçÂãôÁ¥ÄÈåÑ:\n${(c['historyLogs'] as List).join('\n')}\n\n";
    }
    final bytes = utf8.encode(content);
    final blob = web.Blob([bytes.toJS].toJS, web.BlobPropertyBag(type: 'text/plain'));
    final url = web.URL.createObjectURL(blob);
    final anchor = web.document.createElement('a') as web.HTMLAnchorElement;
    anchor.href = url; anchor.download = "HolyHair_Backup.txt"; anchor.click();
    web.URL.revokeObjectURL(url);
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: const Text('ÂêçÂñÆÁ∏ΩË¶Ω'),
        actions: [
          StreamBuilder<QuerySnapshot>(
            stream: FirebaseFirestore.instance.collection('customers').snapshots(),
            builder: (context, snapshot) {
              if (!snapshot.hasData) return const SizedBox();
              return IconButton(
                icon: const Icon(Icons.download, color: LuxuryColor.gold),
                onPressed: () => _downloadBackup(snapshot.data!.docs.map((d) => d.data() as Map<String, dynamic>).toList()),
              );
            }
          )
        ],
      ),
      body: StreamBuilder<QuerySnapshot>(
        stream: FirebaseFirestore.instance.collection('customers').orderBy('lastUpdated', descending: true).snapshots(),
        builder: (context, snapshot) {
          if (!snapshot.hasData) return const Center(child: CircularProgressIndicator(color: LuxuryColor.gold));
          final docs = snapshot.data!.docs;
          return ListView.builder(
            padding: const EdgeInsets.all(15),
            itemCount: docs.length,
            itemBuilder: (context, index) {
              final data = docs[index].data() as Map<String, dynamic>;
              return Card(
                color: LuxuryColor.card,
                shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(15), side: const BorderSide(color: Colors.white10)),
                child: ListTile(
                  title: Text(data['name'], style: const TextStyle(color: LuxuryColor.gold, fontWeight: FontWeight.bold)),
                  subtitle: Text("üìû ${data['phone']}\n‰∏ãÂõûÈ†êÁ¥Ñ: ${data['nextDate'] ?? 'Êú™ÂÆö'}"),
                  onTap: () => _showDetail(context, data),
                ),
              );
            },
          );
        },
      ),
    );
  }

  void _showDetail(BuildContext context, Map<String, dynamic> data) {
    showModalBottomSheet(
      context: context, backgroundColor: LuxuryColor.bg,
      builder: (ctx) => Padding(
        padding: const EdgeInsets.all(20),
        child: Column(crossAxisAlignment: CrossAxisAlignment.start, children: [
          Text(data['name'], style: const TextStyle(color: LuxuryColor.gold, fontSize: 22)),
          const Divider(color: Colors.white24),
          Expanded(child: ListView(children: (data['historyLogs'] as List).map((l) => Text(l.toString(), style: const TextStyle(height: 2))).toList())),
        ]),
      ),
    );
  }
}
