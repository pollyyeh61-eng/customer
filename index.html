import 'package:flutter/material.dart';
import 'package:firebase_core/firebase_core.dart';
import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:intl/intl.dart';

void main() async {
  WidgetsFlutterBinding.ensureInitialized();
  await Firebase.initializeApp(
    options: const FirebaseOptions(
      apiKey: "AIzaSyCOhBN9TH3UJSOSx5XVyQ08f_2RUckvXYU",
      appId: "1:960169055224:web:96d6d47280c5d543bf3c0d",
      messagingSenderId: "960169055224",
      projectId: "holyhairsalon-f73bf",
    ),
  );
  runApp(const HolyHairApp());
}

class HolyHairApp extends StatelessWidget {
  const HolyHairApp({super.key});
  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      debugShowCheckedModeBanner: false,
      theme: ThemeData(
        brightness: Brightness.dark,
        scaffoldBackgroundColor: const Color(0xFF0A0A0A), // 黑金主色
        primaryColor: const Color(0xFFD4AF37),
      ),
      home: const SalonHomePage(),
    );
  }
}

class SalonHomePage extends StatefulWidget {
  const SalonHomePage({super.key});
  @override
  State<SalonHomePage> createState() => _SalonHomePageState();
}

class _SalonHomePageState extends State<SalonHomePage> with SingleTickerProviderStateMixin {
  late AnimationController _glowController;
  final _nameCtrl = TextEditingController();
  final _phoneCtrl = TextEditingController();

  @override
  void initState() {
    super.initState();
    // 4 秒週期的呼吸發光
    _glowController = AnimationController(vsync: this, duration: const Duration(seconds: 4))..repeat(reverse: true);
  }

  @override
  void dispose() {
    _glowController.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: const Text('HOLY HAIR 尊榮管理', style: TextStyle(color: Color(0xFFD4AF37), letterSpacing: 4)),
        backgroundColor: Colors.transparent,
        centerTitle: true,
      ),
      body: Center(
        child: Container(
          constraints: const BoxConstraints(maxWidth: 500), // 限制手機尺寸寬度
          padding: const EdgeInsets.all(30),
          child: Column(
            children: [
              _buildInput(_nameCtrl, "貴賓姓名", Icons.person_outline),
              _buildInput(_phoneCtrl, "聯繫電話", Icons.phone_iphone),
              const SizedBox(height: 50),
              _buildBreathingButton(),
              const SizedBox(height: 40),
              const Divider(color: Color(0xFF8E6D2F)),
              const Text("即時名單同步中", style: TextStyle(color: Color(0xFF8E6D2F), fontSize: 12)),
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildInput(TextEditingController ctrl, String label, IconData icon) {
    return Padding(
      padding: const EdgeInsets.only(bottom: 20),
      child: TextField(
        controller: ctrl,
        decoration: InputDecoration(
          prefixIcon: Icon(icon, color: const Color(0xFFD4AF37)),
          labelText: label,
          filled: true,
          fillColor: const Color(0xFF161616),
          enabledBorder: OutlineInputBorder(borderRadius: BorderRadius.circular(15), borderSide: const BorderSide(color: Colors.white10)),
        ),
      ),
    );
  }

  Widget _buildBreathingButton() {
    return AnimatedBuilder(
      animation: _glowController,
      builder: (context, child) {
        final gold = const Color(0xFFD4AF37);
        final darkGold = const Color(0xFF8E6D2F);
        final color = Color.lerp(darkGold, gold, _glowController.value)!;

        return GestureDetector(
          onTap: () async {
            if (_nameCtrl.text.isEmpty) return;
            await FirebaseFirestore.instance.collection('customers').doc(_nameCtrl.text).set({
              'name': _nameCtrl.text,
              'phone': _phoneCtrl.text,
              'time': FieldValue.serverTimestamp(),
            });
            ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text("已同步至 Firebase")));
          },
          child: Container(
            height: 65,
            decoration: BoxDecoration(
              borderRadius: BorderRadius.circular(35),
              border: Border.all(color: color, width: 2),
              boxShadow: [BoxShadow(color: color.withOpacity(0.5), blurRadius: 20 * _glowController.value, spreadRadius: 2)],
              gradient: LinearGradient(colors: [const Color(0xFF161616), color.withOpacity(0.2)]),
            ),
            child: Center(child: Text("確認儲存資料", style: TextStyle(color: color, fontWeight: FontWeight.bold, fontSize: 18, letterSpacing: 2))),
          ),
        );
      },
    );
  }
}
