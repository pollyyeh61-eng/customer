import 'package:flutter/material.dart';
import 'package:firebase_core/firebase_core.dart';
import 'package:cloud_firestore/cloud_firestore.dart';
import 'dart:convert';
import 'package:intl/intl.dart';
import 'package:url_launcher/url_launcher.dart';
import 'package:web/web.dart' as web;
import 'dart:js_interop';

void main() async {
  WidgetsFlutterBinding.ensureInitialized();
  // 初始化 Firebase 並帶入您的金鑰
  await Firebase.initializeApp(
    options: const FirebaseOptions(
      apiKey: "AIzaSyCOhBN9TH3UJSOSx5XVyQ08f_2RUckvXYU",
      appId: "1:960169055224:web:96d6d47280c5d543bf3c0d",
      messagingSenderId: "960169055224",
      projectId: "holyhairsalon-f73bf",
      authDomain: "holyhairsalon-f73bf.firebaseapp.com",
      storageBucket: "holyhairsalon-f73bf.firebasestorage.app",
    ),
  );
  runApp(const LuxuryCustomerApp());
}

// 奢華黑金配色定義
class LuxuryColor {
  static const Color gold = Color(0xFFD4AF37); // 亮金
  static const Color darkGold = Color(0xFF8E6D2F); // 暗金
  static const Color bg = Color(0xFF0A0A0A); // 深墨黑
  static const Color card = Color(0xFF161616); // 黑色卡片
}

class LuxuryCustomerApp extends StatelessWidget {
  const LuxuryCustomerApp({super.key});
  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      debugShowCheckedModeBanner: false,
      theme: ThemeData(
        brightness: Brightness.dark,
        scaffoldBackgroundColor: LuxuryColor.bg,
        primaryColor: LuxuryColor.gold,
        fontFamily: 'NotoSansTC',
      ),
      home: const CustomerFormPage(),
    );
  }
}

class CustomerFormPage extends StatefulWidget {
  const CustomerFormPage({super.key});
  @override
  State<CustomerFormPage> createState() => _CustomerFormPageState();
}

class _CustomerFormPageState extends State<CustomerFormPage> with SingleTickerProviderStateMixin {
  late AnimationController _glowController;
  final _nameController = TextEditingController();
  final _phoneController = TextEditingController();
  final _noteController = TextEditingController();
  final _serviceController = TextEditingController();
  final _nextDateController = TextEditingController();

  @override
  void initState() {
    super.initState();
    // 4 秒週期的呼吸動畫
    _glowController = AnimationController(
      vsync: this,
      duration: const Duration(seconds: 4),
    )..repeat(reverse: true);
  }

  @override
  void dispose() {
    _glowController.dispose();
    super.dispose();
  }

  Future<void> _saveToFirebase() async {
    if (_nameController.text.isEmpty) {
      ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text("請填寫貴賓姓名"), backgroundColor: Colors.red));
      return;
    }

    String log = "${DateFormat('yyyy-MM-dd').format(DateTime.now())}: ${_serviceController.text}";
    
    try {
      await FirebaseFirestore.instance.collection('customers').doc(_nameController.text).set({
        'name': _nameController.text,
        'phone': _phoneController.text,
        'note': _noteController.text,
        'nextDate': _nextDateController.text,
        'historyLogs': FieldValue.arrayUnion([log]),
        'lastUpdated': FieldValue.serverTimestamp(),
      }, SetOptions(merge: true));

      ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text("✅ 資料已安全存儲至雲端")));
      _clear();
    } catch (e) {
      ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text("錯誤: $e")));
    }
  }

  void _clear() {
    _nameController.clear(); _phoneController.clear(); _noteController.clear();
    _serviceController.clear(); _nextDateController.clear();
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: const Text('HolyHair 客戶尊榮檔案', style: TextStyle(color: LuxuryColor.gold, letterSpacing: 2)),
        backgroundColor: Colors.transparent,
        elevation: 0,
      ),
      body: SingleChildScrollView(
        padding: const EdgeInsets.all(25),
        child: Column(
          children: [
            _buildInput(_nameController, "貴賓尊姓大名", Icons.person_outline),
            _buildInput(_phoneController, "聯繫電話", Icons.phone_iphone),
            _buildInput(_noteController, "專屬備註 (膚質、髮況)", Icons.auto_awesome, maxLines: 2),
            _buildInput(_serviceController, "本次服務紀實", Icons.history_edu, maxLines: 2),
            const SizedBox(height: 30),
            _buildBreathingButton(),
          ],
        ),
      ),
    );
  }

  Widget _buildInput(TextEditingController ctrl, String label, IconData icon, {int maxLines = 1}) {
    return Padding(
      padding: const EdgeInsets.only(bottom: 20),
      child: TextField(
        controller: ctrl,
        maxLines: maxLines,
        decoration: InputDecoration(
          prefixIcon: Icon(icon, color: LuxuryColor.darkGold),
          labelText: label,
          labelStyle: const TextStyle(color: Colors.grey),
          enabledBorder: OutlineInputBorder(borderSide: const BorderSide(color: Colors.white10), borderRadius: BorderRadius.circular(12)),
          focusedBorder: OutlineInputBorder(borderSide: const BorderSide(color: LuxuryColor.gold), borderRadius: BorderRadius.circular(12)),
          filled: true,
          fillColor: LuxuryColor.card,
        ),
      ),
    );
  }

  Widget _buildBreathingButton() {
    return AnimatedBuilder(
      animation: _glowController,
      builder: (context, child) {
        final color = Color.lerp(LuxuryColor.darkGold, LuxuryColor.gold, _glowController.value)!;
        return GestureDetector(
          onTap: _saveToFirebase,
          child: Container(
            height: 60,
            decoration: BoxDecoration(
              borderRadius: BorderRadius.circular(30),
              border: Border.all(color: color, width: 1.5),
              boxShadow: [
                BoxShadow(color: color.withOpacity(0.4), blurRadius: 15 * _glowController.value, spreadRadius: 2),
              ],
              gradient: LinearGradient(colors: [LuxuryColor.card, color.withOpacity(0.2)]),
            ),
            child: Center(
              child: Text("同步雲端資料庫", style: TextStyle(color: color, fontWeight: FontWeight.bold, letterSpacing: 3, fontSize: 18)),
            ),
          ),
        );
      },
    );
  }
}
