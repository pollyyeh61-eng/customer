import 'package:flutter/material.dart';
import 'package:firebase_core/firebase_core.dart';
import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:intl/intl.dart';

void main() async {
  WidgetsFlutterBinding.ensureInitialized();
  // 請確保您已在 Firebase Console 完成 Web 專案設定，並放入 firebase_options.dart
  // await Firebase.initializeApp(options: DefaultFirebaseOptions.currentPlatform);
  runApp(const LuxuryCustomerApp());
}

class LuxuryTheme {
  static const Color darkBg = Color(0xFF0A0A0A);
  static const Color darkCard = Color(0xFF161616);
  static const Color mutedGold = Color(0xFF8E6D2F);
  static const Color brightGold = Color(0xFFD4AF37);
  static const Color softGold = Color(0xFFFFD700);
}

class LuxuryCustomerApp extends StatelessWidget {
  const LuxuryCustomerApp({super.key});

  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      debugShowCheckedModeBanner: false,
      title: '至臻客戶管理',
      theme: ThemeData(
        brightness: Brightness.dark,
        scaffoldBackgroundColor: LuxuryTheme.darkBg,
        primaryColor: LuxuryTheme.brightGold,
        fontFamily: 'NotoSansTC', // 建議加入繁體中文字體
      ),
      home: const CustomerFormPage(),
    );
  }
}

// --- 客戶資料模型 ---
class Customer {
  final String id;
  final String name, phone, bloodType, constellation, note;
  final List<dynamic> historyLogs;

  Customer({
    required this.id,
    required this.name,
    this.phone = '',
    this.bloodType = '',
    this.constellation = '',
    this.note = '',
    this.historyLogs = const [],
  });

  Map<String, dynamic> toMap() => {
    'name': name, 'phone': phone, 'bloodType': bloodType,
    'constellation': constellation, 'note': note,
    'historyLogs': historyLogs,
    'lastUpdate': FieldValue.serverTimestamp(),
  };
}

class CustomerFormPage extends StatefulWidget {
  const CustomerFormPage({super.key});
  @override
  State<CustomerFormPage> createState() => _CustomerFormPageState();
}

class _CustomerFormPageState extends State<CustomerFormPage> with SingleTickerProviderStateMixin {
  late AnimationController _glowController;
  final _nameController = TextEditingController();
  final _phoneController = TextEditingController();
  final _noteController = TextEditingController();
  final _serviceController = TextEditingController();

  @override
  void initState() {
    super.initState();
    // 4 秒週期的發光動畫
    _glowController = AnimationController(
      vsync: this,
      duration: const Duration(seconds: 4),
    )..repeat(reverse: true);
  }

  @override
  void dispose() {
    _glowController.dispose();
    super.dispose();
  }

  Future<void> _submitData() async {
    if (_nameController.text.isEmpty) return;

    // Firebase Firestore 儲存
    await FirebaseFirestore.instance.collection('customers').doc(_nameController.text).set({
      'name': _nameController.text,
      'phone': _phoneController.text,
      'note': _noteController.text,
      'historyLogs': FieldValue.arrayUnion(["${DateFormat('yyyy-MM-dd').format(DateTime.now())}: ${_serviceController.text}"]),
    }, SetOptions(merge: true));

    ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text('尊榮資料已同步雲端'), backgroundColor: LuxuryTheme.mutedGold));
    _clear();
  }

  void _clear() {
    _nameController.clear(); _phoneController.clear(); _noteController.clear(); _serviceController.clear();
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        backgroundColor: Colors.transparent,
        elevation: 0,
        title: const Text('客戶尊榮檔案', style: TextStyle(color: LuxuryTheme.brightGold, letterSpacing: 2)),
      ),
      body: SingleChildScrollView(
        padding: const EdgeInsets.all(24),
        child: Column(
          children: [
            _buildLuxuryInput(_nameController, '貴賓尊姓大名', Icons.person_outline),
            _buildLuxuryInput(_phoneController, '聯繫電話', Icons.phone_iphone_outlined),
            _buildLuxuryInput(_noteController, '專屬備註 (膚質、喜好)', Icons.auto_awesome_outlined, maxLines: 3),
            _buildLuxuryInput(_serviceController, '本次服務紀實', Icons.history_edu_outlined, maxLines: 2),
            const SizedBox(height: 40),
            _buildBreathingButton(),
          ],
        ),
      ),
    );
  }

  // 呼吸發光輸入框
  Widget _buildLuxuryInput(TextEditingController controller, String label, IconData icon, {int maxLines = 1}) {
    return Container(
      margin: const EdgeInsets.only(bottom: 20),
      decoration: BoxDecoration(
        color: LuxuryTheme.darkCard,
        borderRadius: BorderRadius.circular(12),
        border: Border.all(color: LuxuryTheme.mutedGold.withOpacity(0.3)),
      ),
      child: TextField(
        controller: controller,
        maxLines: maxLines,
        style: const TextStyle(color: Colors.white),
        decoration: InputDecoration(
          prefixIcon: Icon(icon, color: LuxuryTheme.mutedGold),
          labelText: label,
          labelStyle: const TextStyle(color: Colors.grey),
          border: InputBorder.none,
          contentPadding: const EdgeInsets.all(16),
        ),
      ),
    );
  }

  // 4秒週期發光按鈕
  Widget _buildBreathingButton() {
    return AnimatedBuilder(
      animation: _glowController,
      builder: (context, child) {
        final color = Color.lerp(LuxuryTheme.mutedGold, LuxuryTheme.softGold, _glowController.value);
        final glow = _glowController.value * 15.0;

        return GestureDetector(
          onTap: _submitData,
          child: Container(
            height: 60,
            width: double.infinity,
            decoration: BoxDecoration(
              gradient: LinearGradient(colors: [color!, LuxuryTheme.darkCard], begin: Alignment.topLeft, end: Alignment.bottomRight),
              borderRadius: BorderRadius.circular(30),
              boxShadow: [
                BoxShadow(color: color.withOpacity(0.5), blurRadius: glow, spreadRadius: glow / 4),
              ],
              border: Border.all(color: color, width: 1.5),
            ),
            child: const Center(
              child: Text(
                '確認並同步雲端',
                style: TextStyle(color: Colors.white, fontSize: 18, fontWeight: FontWeight.bold, letterSpacing: 3),
              ),
            ),
          ),
        );
      },
    );
  }
}
