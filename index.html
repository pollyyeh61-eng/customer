import 'package:flutter/material.dart';
import 'package:firebase_core/firebase_core.dart'; // éœ€å®‰è£ firebase_core
import 'package:cloud_firestore/cloud_firestore.dart'; // éœ€å®‰è£ cloud_firestore
import 'dart:convert';
import 'package:intl/intl.dart';
import 'package:url_launcher/url_launcher.dart';
import 'package:web/web.dart' as web;
import 'dart:js_interop';

// æ³¨æ„ï¼šè«‹ç¢ºä¿å·²åœ¨ Firebase Console å®Œæˆè¨­å®šï¼Œä¸¦åŸ·è¡Œ flutterfire configure
void main() async {
  WidgetsFlutterBinding.ensureInitialized();
  // await Firebase.initializeApp(); 
  runApp(const CustomerWebPage());
}

class LuxuryTheme {
  static const Color blackBg = Color(0xFF0A0A0A); // æ·±å¢¨é»‘
  static const Color darkCard = Color(0xFF161616); // é»‘è‰²å¡ç‰‡
  static const Color mutedGold = Color(0xFF8E6D2F); // æš—é‡‘
  static const Color brightGold = Color(0xFFD4AF37); // äº®é‡‘
}

class CustomerWebPage extends StatelessWidget {
  const CustomerWebPage({super.key});

  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      debugShowCheckedModeBanner: false,
      title: 'è‡³è‡»å®¢æˆ¶ç®¡ç†ç³»çµ±',
      theme: ThemeData(
        brightness: Brightness.dark,
        scaffoldBackgroundColor: LuxuryTheme.blackBg,
        primaryColor: LuxuryTheme.brightGold,
        appBarTheme: const AppBarTheme(
          backgroundColor: LuxuryTheme.blackBg,
          elevation: 0,
          centerTitle: true,
          titleTextStyle: TextStyle(fontSize: 20, fontWeight: FontWeight.bold, color: LuxuryTheme.brightGold, letterSpacing: 2),
        ),
      ),
      home: const CustomerFormPage(),
    );
  }
}

// --- å®¢æˆ¶è³‡æ–™æ¨¡å‹ (ç¶­æŒåŸçµæ§‹) ---
class Customer {
  String name, phone, bloodType, constellation, nextDate, nextItem, note;
  List<String> historyLogs;

  Customer({
    required this.name,
    this.phone = '', this.bloodType = '',
    this.constellation = '', this.nextDate = '', this.nextItem = '',
    this.note = '', List<String>? historyLogs,
  }) : historyLogs = historyLogs ?? [];

  Map<String, dynamic> toJson() => {
    'name': name, 'phone': phone, 'bloodType': bloodType,
    'constellation': constellation, 'nextDate': nextDate, 'nextItem': nextItem,
    'note': note, 'historyLogs': historyLogs,
    'updatedAt': FieldValue.serverTimestamp(),
  };

  factory Customer.fromFirestore(Map<String, dynamic> json) => Customer(
    name: json['name'] ?? '',
    phone: json['phone'] ?? '',
    bloodType: json['bloodType'] ?? '',
    constellation: json['constellation'] ?? '',
    nextDate: json['nextDate'] ?? '',
    nextItem: json['nextItem'] ?? '',
    note: json['note'] ?? '',
    historyLogs: List<String>.from(json['historyLogs'] ?? []),
  );
}

class CustomerFormPage extends StatefulWidget {
  const CustomerFormPage({super.key});
  @override
  State<CustomerFormPage> createState() => _CustomerFormPageState();
}

class _CustomerFormPageState extends State<CustomerFormPage> with SingleTickerProviderStateMixin {
  late AnimationController _glowController;
  final _nameController = TextEditingController();
  final _phoneController = TextEditingController();
  final _noteController = TextEditingController();
  final _currentServiceController = TextEditingController();
  final _nextDateController = TextEditingController();
  final _nextItemController = TextEditingController();

  String? _selectedBlood;
  String? _selectedZodiac;
  final List<String> _bloodTypes = ['A', 'B', 'O', 'AB'];
  final List<String> _zodiacs = ['ç‰¡ç¾Šåº§', 'é‡‘ç‰›åº§', 'é›™å­åº§', 'å·¨èŸ¹åº§', 'ç…å­åº§', 'è™•å¥³åº§', 'å¤©ç§¤åº§', 'å¤©è åº§', 'å°„æ‰‹åº§', 'æ‘©ç¾¯åº§', 'æ°´ç“¶åº§', 'é›™é­šåº§'];

  @override
  void initState() {
    super.initState();
    _glowController = AnimationController(
      vsync: this,
      duration: const Duration(seconds: 4), // 4ç§’ä¸€é€±æœŸ
    )..repeat(reverse: true);
  }

  @override
  void dispose() {
    _glowController.dispose();
    super.dispose();
  }

  void _openGoogleCalendar(Customer customer) async {
    if (customer.nextDate.isEmpty) return;
    final String title = Uri.encodeComponent('é ç´„ï¼š${customer.name}');
    final String desc = Uri.encodeComponent('é …ç›®ï¼š${customer.nextItem}\nå‚™è¨»ï¼š${customer.note}');
    final String dateFormatted = customer.nextDate.replaceAll(RegExp(r'[- : ]'), '');
    final String url = "https://www.google.com/calendar/render?action=TEMPLATE&text=$title&details=$desc&dates=${dateFormatted}00/${dateFormatted}00";
    final uri = Uri.parse(url);
    if (await canLaunchUrl(uri)) await launchUrl(uri);
  }

  // --- æ”¹ç‚º Firebase å„²å­˜ ---
  Future<void> _saveData() async {
    String name = _nameController.text.trim();
    if (name.isEmpty) {
      ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text('âŒ è²´è³“å§“åç‚ºå¿…å¡«'), backgroundColor: Colors.red));
      return;
    }

    String today = DateFormat('yyyy-MM-dd').format(DateTime.now());
    String serviceLog = _currentServiceController.text.trim();
    String newLog = "$today: ${serviceLog.isEmpty ? 'ç„¡ç´€éŒ„' : serviceLog}";

    try {
      final docRef = FirebaseFirestore.instance.collection('customers').doc(name);
      
      // ä½¿ç”¨ Firebase çš„ ArrayUnion ä¾†è¿½åŠ ç´€éŒ„
      await docRef.set({
        'name': name,
        'phone': _phoneController.text,
        'bloodType': _selectedBlood ?? '',
        'constellation': _selectedZodiac ?? '',
        'nextDate': _nextDateController.text,
        'nextItem': _nextItemController.text,
        'note': _noteController.text,
      }, SetOptions(merge: true));

      await docRef.update({
        'historyLogs': FieldValue.arrayUnion([newLog]),
      });

      if (_nextDateController.text.isNotEmpty) {
        _openGoogleCalendar(Customer(name: name, nextDate: _nextDateController.text, nextItem: _nextItemController.text, note: _noteController.text));
      }

      _clear();
      ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text('âœ… è²´è³“è³‡æ–™å·²åŒæ­¥è‡³é›²ç«¯'), backgroundColor: LuxuryTheme.mutedGold));
    } catch (e) {
      ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text('å„²å­˜å¤±æ•—: $e')));
    }
  }

  void _clear() {
    _nameController.clear(); _phoneController.clear(); _noteController.clear(); 
    _currentServiceController.clear(); _nextDateController.clear(); _nextItemController.clear();
    setState(() { _selectedBlood = null; _selectedZodiac = null; });
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: const Text('å®¢æˆ¶ç®¡ç†ç³»çµ±'),
        actions: [
          TextButton.icon(
            icon: const Icon(Icons.list, color: LuxuryTheme.brightGold),
            label: const Text('åå–®ç¸½è¦½', style: TextStyle(color: LuxuryTheme.brightGold)),
            onPressed: () => Navigator.push(context, MaterialPageRoute(builder: (context) => const CustomerListPage())),
          ),
          const SizedBox(width: 10),
        ],
      ),
      body: SingleChildScrollView(
        padding: const EdgeInsets.symmetric(horizontal: 20, vertical: 10),
        child: Column(
          children: [
            _buildField(_nameController, 'è²´è³“å§“å *', Icons.person_outline),
            _buildField(_phoneController, 'é€£çµ¡é›»è©±', Icons.phone_android_outlined, keyboardType: TextInputType.phone),
            Row(children: [
              Expanded(child: _buildDropdown('è¡€å‹', _bloodTypes, _selectedBlood, (v) => setState(() => _selectedBlood = v))),
              const SizedBox(width: 15),
              Expanded(child: _buildDropdown('æ˜Ÿåº§', _zodiacs, _selectedZodiac, (v) => setState(() => _selectedZodiac = v))),
            ]),
            const SizedBox(height: 15),
            _buildField(_noteController, 'ç‰¹åˆ¥å‚™è¨» (è†šè³ªã€å–œå¥½ç­‰)', Icons.auto_awesome_outlined, maxLines: 2),
            _buildField(_currentServiceController, 'æœ¬æ¬¡æœå‹™ç´€éŒ„å…§å®¹', Icons.history_edu_outlined, maxLines: 2),
            _buildAppointmentSection(),
            const SizedBox(height: 40),
            _buildLuxuryButton(),
          ],
        ),
      ),
    );
  }

  Widget _buildLuxuryButton() {
    return AnimatedBuilder(
      animation: _glowController,
      builder: (context, child) {
        final color = Color.lerp(LuxuryTheme.mutedGold, LuxuryTheme.brightGold, _glowController.value)!;
        return GestureDetector(
          onTap: _saveData,
          child: Container(
            height: 60,
            width: double.infinity,
            decoration: BoxDecoration(
              borderRadius: BorderRadius.circular(15),
              border: Border.all(color: color, width: 2),
              boxShadow: [
                BoxShadow(color: color.withOpacity(0.3), blurRadius: 10 * _glowController.value, spreadRadius: 2 * _glowController.value),
              ],
              gradient: LinearGradient(colors: [LuxuryTheme.darkCard, color.withOpacity(0.1)]),
            ),
            child: Center(
              child: Text('å„²å­˜ä¸¦åŒæ­¥æ—¥æ›†', style: TextStyle(color: color, fontSize: 18, fontWeight: FontWeight.bold, letterSpacing: 2)),
            ),
          ),
        );
      },
    );
  }

  Widget _buildAppointmentSection() {
    return Container(
      padding: const EdgeInsets.all(15),
      decoration: BoxDecoration(color: LuxuryTheme.darkCard, borderRadius: BorderRadius.circular(12), border: Border.all(color: Colors.white10)),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          const Text("ğŸ“… ä¸‹æ¬¡é ç´„æé†’", style: TextStyle(fontWeight: FontWeight.bold, color: LuxuryTheme.mutedGold)),
          const SizedBox(height: 10),
          _buildField(_nextItemController, 'é ç´„é …ç›®', Icons.spa_outlined),
          TextField(
            controller: _nextDateController, readOnly: true,
            decoration: const InputDecoration(labelText: 'æ—¥æœŸèˆ‡æ™‚é–“', suffixIcon: Icon(Icons.calendar_month, color: LuxuryTheme.mutedGold), border: OutlineInputBorder()),
            onTap: () async {
              DateTime? d = await showDatePicker(context: context, initialDate: DateTime.now(), firstDate: DateTime.now(), lastDate: DateTime(2100));
              if (d != null) {
                TimeOfDay? t = await showTimePicker(context: context, initialTime: TimeOfDay.now());
                if (t != null) {
                  final full = DateTime(d.year, d.month, d.day, t.hour, t.minute);
                  setState(() => _nextDateController.text = DateFormat('yyyy-MM-dd HH:mm').format(full));
                }
              }
            },
          ),
        ],
      ),
    );
  }

  Widget _buildField(TextEditingController c, String l, IconData icon, {int maxLines = 1, TextInputType keyboardType = TextInputType.text}) => 
    Padding(padding: const EdgeInsets.only(bottom: 15), child: TextField(controller: c, maxLines: maxLines, keyboardType: keyboardType, decoration: InputDecoration(prefixIcon: Icon(icon, color: LuxuryTheme.mutedGold), labelText: l, labelStyle: const TextStyle(color: Colors.grey), border: const OutlineInputBorder())));

  Widget _buildDropdown(String label, List<String> items, String? current, ValueChanged<String?> onChanged) =>
    DropdownButtonFormField<String>(decoration: InputDecoration(labelText: label, border: const OutlineInputBorder()), value: current, items: items.map((s) => DropdownMenuItem(value: s, child: Text(s))).toList(), onChanged: onChanged);
}

// --- å®¢æˆ¶åˆ—è¡¨é é¢ (æ”¹ç‚º StreamBuilder å¯¦æ™‚è®€å–) ---
class CustomerListPage extends StatelessWidget {
  const CustomerListPage({super.key});

  void _downloadBackup(List<Customer> list) {
    if (list.isEmpty) return;
    String content = "è²´è³“è³‡æ–™å®Œæ•´å‚™ä»½\nåŒ¯å‡ºæ™‚é–“: ${DateFormat('yyyy-MM-dd HH:mm').format(DateTime.now())}\n" + "="*40 + "\n";
    for (var c in list) {
      content += "\nã€${c.name}ã€‘\né›»è©±ï¼š${c.phone}\næ­·å²æœå‹™ï¼š\n${c.historyLogs.join('\n')}\n" + "-"*30 + "\n";
    }
    final bytes = utf8.encode(content);
    final blob = web.Blob([bytes.toJS].toJS, web.BlobPropertyBag(type: 'text/plain'));
    final url = web.URL.createObjectURL(blob);
    final anchor = web.document.createElement('a') as web.HTMLAnchorElement;
    anchor.href = url;
    anchor.download = "customer_backup.txt";
    anchor.click();
    web.URL.revokeObjectURL(url);
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: const Text('åå–®ç¸½è¦½')),
      body: StreamBuilder<QuerySnapshot>(
        stream: FirebaseFirestore.instance.collection('customers').snapshots(),
        builder: (context, snapshot) {
          if (!snapshot.hasData) return const Center(child: CircularProgressIndicator());
          final list = snapshot.data!.docs.map((doc) => Customer.fromFirestore(doc.data() as Map<String, dynamic>)).toList();
          
          return Column(
            children: [
              IconButton(icon: const Icon(Icons.file_download, color: LuxuryTheme.brightGold), onPressed: () => _downloadBackup(list)),
              Expanded(
                child: ListView.builder(
                  itemCount: list.length,
                  itemBuilder: (context, i) {
                    final c = list[i];
                    return Card(
                      color: LuxuryTheme.darkCard,
                      margin: const EdgeInsets.symmetric(horizontal: 15, vertical: 8),
                      child: ListTile(
                        title: Text(c.name, style: const TextStyle(color: LuxuryTheme.brightGold, fontWeight: FontWeight.bold)),
                        subtitle: Text("ğŸ“ ${c.phone}\nå‚™è¨»: ${c.note}"),
                        isThreeLine: true,
                      ),
                    );
                  },
                ),
              ),
            ],
          );
        },
      ),
    );
  }
}
